---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import { BlogPostCard } from '@/components/ui/blog-post-card';
import { calculateReadingTime } from '@/utils/readingTime';
import { Tag } from 'lucide-react';

export async function getStaticPaths() {
  const allPosts = await getCollection('blog', ({ data }) => !data.draft);

  // 태그별로 그룹화
  const tagMap = new Map<string, any[]>();

  allPosts.forEach(post => {
    post.data.tags.forEach(tag => {
      if (!tagMap.has(tag)) {
        tagMap.set(tag, []);
      }
      tagMap.get(tag)!.push(post);
    });
  });

  // 각 태그에 대한 경로 생성
  return Array.from(tagMap.entries()).map(([tag, posts]) => ({
    params: { tag },
    props: {
      tag,
      posts: posts.sort((a, b) => b.data.date.getTime() - a.data.date.getTime()),
    },
  }));
}

const { tag, posts } = Astro.props;

// Add reading time to posts
const postsWithReadingTime = posts.map(post => ({
  ...post,
  readingTime: post.body ? calculateReadingTime(post.body) : '1분'
}));
---

<BaseLayout
  title={`#${tag} - Tolerblanc's Blog`}
  description={`${tag} 태그가 있는 모든 포스트 (${posts.length}개)`}
  currentPath={Astro.url.pathname}
>
  <div class="container mx-auto px-4 py-8 max-w-7xl">
    <!-- Tag Header -->
    <header class="text-center mb-12 pb-8 border-b border-border">
      <h1 class="text-4xl md:text-5xl font-bold mb-4 flex items-center justify-center gap-3">
        <Tag size={32} />
        #{tag}
      </h1>
      <p class="text-lg text-muted-foreground">
        {posts.length}개의 포스트
      </p>
    </header>

    <!-- Posts Grid -->
    <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
      {postsWithReadingTime.map((post) => (
        <BlogPostCard
          title={post.data.title}
          excerpt={post.data.excerpt}
          date={post.data.date}
          slug={post.id}
          categories={post.data.categories}
          tags={post.data.tags}
          readingTime={post.readingTime}
          client:load
        />
      ))}
    </div>
  </div>
</BaseLayout>
