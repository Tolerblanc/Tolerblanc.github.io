---
import { getCollection } from 'astro:content';
import BaseLayout from '@/layouts/BaseLayout.astro';
import { BlogPostCard } from '@/components/ui/blog-post-card';
import { Button } from '@/components/ui/button';
import { calculateReadingTime } from '@/utils/readingTime';
import { POPULAR_POSTS } from '@/constants';
import { Book, TrendingUp } from 'lucide-react';

const title = "인생은 B와 D사이 Code다";
const description = "Tolerblanc의 기술 블로그";

// Get all published blog posts
const allPosts = await getCollection('blog', ({ data }) => !data.draft);

// Popular posts (based on Google Analytics)
const popularPosts = allPosts
  .filter(post => POPULAR_POSTS.includes(post.id as any))
  .sort((a, b) => {
    const aIndex = POPULAR_POSTS.indexOf(a.id as any);
    const bIndex = POPULAR_POSTS.indexOf(b.id as any);
    return aIndex - bIndex;
  })
  .map(post => ({
    ...post,
    readingTime: post.body ? calculateReadingTime(post.body) : '1분'
  }));

// Recent posts
const recentPosts = allPosts
  .sort((a, b) => b.data.date.getTime() - a.data.date.getTime())
  .slice(0, 6)
  .map(post => ({
    ...post,
    readingTime: post.body ? calculateReadingTime(post.body) : '1분'
  }));
---

<BaseLayout title={title} description={description}>
  <div class="container mx-auto px-4 py-8 max-w-7xl">
    <!-- Popular Posts -->
    <section class="mb-16">
      <div class="flex items-center justify-between mb-8">
        <h2 class="text-3xl font-bold flex items-center gap-3">
          <TrendingUp size={28} className="text-primary" />
          인기 글
        </h2>
        <span class="text-sm text-muted-foreground">
          조회수 기준
        </span>
      </div>

      <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
        {popularPosts.map((post) => (
          <BlogPostCard
            title={post.data.title}
            excerpt={post.data.excerpt}
            date={post.data.date}
            slug={post.id}
            categories={post.data.categories}
            tags={post.data.tags}
            readingTime={post.readingTime}
            client:load
          />
        ))}
      </div>
    </section>

    <!-- Recent Posts -->
    <section class="mb-16">
      <div class="flex items-center justify-between mb-8">
        <h2 class="text-3xl font-bold flex items-center gap-3">
          <Book size={28} />
          최근 포스트
        </h2>
        <Button variant="outline" asChild client:load>
          <a href="/posts">
            전체 보기 →
          </a>
        </Button>
      </div>

      <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
        {recentPosts.map((post) => (
          <BlogPostCard
            title={post.data.title}
            excerpt={post.data.excerpt}
            date={post.data.date}
            slug={post.id}
            categories={post.data.categories}
            tags={post.data.tags}
            readingTime={post.readingTime}
            client:load
          />
        ))}
      </div>
    </section>
  </div>
</BaseLayout>

