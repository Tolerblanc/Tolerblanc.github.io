---
import { getCollection } from 'astro:content';
import BaseLayout from '../../../layouts/BaseLayout.astro';
import { BlogPostCard } from '@/components/ui/blog-post-card';
import { calculateReadingTime } from '@/utils/readingTime';
import { Layers, Clock, Monitor, Code, Brain, Box, Palette, DollarSign, HardDrive, Terminal, FileCode, BookOpen, Globe, Folder } from 'lucide-react';

export async function getStaticPaths() {
  const allPosts = await getCollection('blog', ({ data }) => !data.draft);

  // 카테고리별로 그룹화
  const categoryMap = new Map<string, any[]>();

  allPosts.forEach(post => {
    const category = post.id.split('/')[0];
    if (!categoryMap.has(category)) {
      categoryMap.set(category, []);
    }
    categoryMap.get(category)!.push(post);
  });

  // 각 카테고리에 대한 경로 생성
  return Array.from(categoryMap.entries()).map(([category, posts]) => ({
    params: { category },
    props: {
      category,
      posts: posts.sort((a, b) => b.data.date.getTime() - a.data.date.getTime()).map(post => {
        const readingTime = post.body ? calculateReadingTime(post.body) : '1분';
        return {
          id: post.id,
          slug: post.slug,
          data: post.data,
          readingTime,
        };
      }),
    },
  }));
}

const { category, posts } = Astro.props;

// 카테고리 레이블 및 Lucide 아이콘 매핑
const categoryIcons: Record<string, any> = {
  '9oormthon_challenge': Layers,
  'algorithm': Clock,
  'boj': Monitor,
  'cpp': Code,
  'dl': Brain,
  'docker': Box,
  'graphics': Palette,
  'javascript': Code,
  'leetcode': DollarSign,
  'os': HardDrive,
  'programmers': Terminal,
  'python': FileCode,
  'retrospective': Clock,
  'review': BookOpen,
  'unix': Terminal,
  'web_fundamentals': Globe,
  '혼공학습단': BookOpen,
};

const categoryLabels: Record<string, string> = {
  '9oormthon_challenge': '9oormthon',
  'algorithm': 'Algorithm',
  'boj': 'BOJ',
  'cpp': 'C++',
  'dl': 'Deep Learning',
  'docker': 'Docker',
  'graphics': 'Graphics',
  'javascript': 'JavaScript',
  'leetcode': 'LeetCode',
  'os': 'OS',
  'programmers': 'Programmers',
  'python': 'Python',
  'retrospective': 'Retrospective',
  'review': 'Review',
  'unix': 'Unix',
  'web_fundamentals': 'Web Fundamentals',
  '혼공학습단': '혼공학습단',
};

const Icon = categoryIcons[category] || Folder;
const label = categoryLabels[category] || category;
---

<BaseLayout
  title={`${label} - Tolerblanc's Blog`}
  description={`${label} 카테고리의 모든 포스트 (${posts.length}개)`}
  currentPath={Astro.url.pathname}
>
  <div class="category-page">
    <header class="category-header">
      <div class="category-icon">
        <Icon size={48} />
      </div>
      <h1 class="category-title">{label}</h1>
      <p class="category-count">{posts.length}개의 포스트</p>
    </header>

    <div class="posts-grid">
      {posts.map((post) => (
        <BlogPostCard
          title={post.data.title}
          excerpt={post.data.excerpt}
          date={post.data.date}
          slug={post.id}
          categories={post.data.categories}
          tags={post.data.tags}
          readingTime={post.readingTime}
          client:load
        />
      ))}
    </div>
  </div>
</BaseLayout>

<style>
  .category-page {
    max-width: 1200px;
    margin: 0 auto;
  }

  /* ===== 카테고리 헤더 ===== */
  .category-header {
    text-align: center;
    margin-bottom: var(--spacing-12);
    padding-bottom: var(--spacing-8);
    border-bottom: 2px solid var(--color-border-primary);
  }

  .category-icon {
    font-size: var(--font-size-5xl);
    margin-bottom: var(--spacing-4);
  }

  .category-title {
    font-size: var(--font-size-4xl);
    font-weight: var(--font-weight-bold);
    color: var(--color-text-primary);
    margin-bottom: var(--spacing-2);
    letter-spacing: -0.02em;
  }

  .category-count {
    font-size: var(--font-size-lg);
    color: var(--color-text-tertiary);
    font-weight: var(--font-weight-medium);
  }

  /* ===== 게시글 그리드 ===== */
  .posts-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--spacing-6);
  }

  @media (min-width: 768px) {
    .posts-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (min-width: 1024px) {
    .posts-grid {
      grid-template-columns: repeat(3, 1fr);
    }
  }
</style>
