---
// Reading progress indicator
// Shows a progress bar at the top of the page indicating reading progress
---

<div class="reading-progress">
  <div class="reading-progress-bar"></div>
</div>

<script is:inline>
  (function() {
    // Store cleanup function to prevent memory leaks
    let cleanupReadingProgress = null;

    function initReadingProgress() {
      // Cleanup previous instance
      if (cleanupReadingProgress) {
        cleanupReadingProgress();
      }

      const progressBar = document.querySelector('.reading-progress-bar');
      const progressContainer = document.querySelector('.reading-progress');

      if (!progressBar || !progressContainer) {
        return;
      }

      // Check if sidebar exists in the DOM
      const hasSidebar = document.querySelector('.sidebar') !== null;

      // Adjust position based on sidebar presence
      if (hasSidebar) {
        const sidebarWidth = getComputedStyle(document.documentElement).getPropertyValue('--layout-sidebar-width');
        progressContainer.style.left = sidebarWidth;
      } else {
        progressContainer.style.left = '0';
      }

      function updateProgress() {
        const windowHeight = window.innerHeight;
        const documentHeight = document.documentElement.scrollHeight;
        const scrollTop = window.scrollY || window.pageYOffset;

        const scrollableHeight = documentHeight - windowHeight;

        if (scrollableHeight <= 0) {
          progressBar.style.width = '0%';
          return;
        }

        const progress = (scrollTop / scrollableHeight) * 100;
        const finalProgress = Math.min(Math.max(progress, 0), 100);

        progressBar.style.width = finalProgress + '%';
      }

      // Event listeners with throttling for better performance
      let ticking = false;

      const scrollHandler = function() {
        if (!ticking) {
          window.requestAnimationFrame(function() {
            updateProgress();
            ticking = false;
          });
          ticking = true;
        }
      };

      window.addEventListener('scroll', scrollHandler, { passive: true });
      window.addEventListener('resize', updateProgress, { passive: true });

      // Initial update
      updateProgress();

      // Cleanup function
      cleanupReadingProgress = function() {
        window.removeEventListener('scroll', scrollHandler);
        window.removeEventListener('resize', updateProgress);
      };
    }

    // Initialize on load
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initReadingProgress);
    } else {
      initReadingProgress();
    }

    // Re-initialize on navigation (for View Transitions)
    document.addEventListener('astro:page-load', initReadingProgress);

    // Cleanup on before swap (for View Transitions)
    document.addEventListener('astro:before-swap', function() {
      if (cleanupReadingProgress) {
        cleanupReadingProgress();
      }
    });
  })();
</script>

<style>
  .reading-progress {
    position: fixed;
    top: var(--layout-header-height);
    left: 0;
    right: 0;
    height: 3px;
    background-color: var(--color-border-primary);
    z-index: calc(var(--z-fixed) + 1);
    overflow: hidden;
    transition: left var(--transition-base);
  }

  .reading-progress-bar {
    height: 100%;
    width: 0%;
    background: linear-gradient(
      90deg,
      var(--color-accent-primary) 0%,
      var(--color-accent-hover) 100%
    );
    transition: width 0.1s ease-out;
  }

  /* Hide on very short pages */
  @media (max-height: 600px) {
    .reading-progress {
      display: none;
    }
  }

  /* Mobile: Reset to full width */
  @media (max-width: 768px) {
    .reading-progress {
      left: 0 !important; /* Override JavaScript adjustment on mobile */
    }
  }
</style>
