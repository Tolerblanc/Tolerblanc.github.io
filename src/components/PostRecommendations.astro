---
/**
 * Post Recommendations Component
 *
 * 현재 게시글과 관련된 다른 게시글을 추천합니다.
 *
 * 추천 로직:
 * 1. 같은 카테고리의 게시글 우선
 * 2. 같은 태그를 많이 공유하는 게시글
 * 3. 최대 3개까지 표시
 */

import type { CollectionEntry } from 'astro:content';
import { getCollection } from 'astro:content';
import { formatDateShort } from '@/utils/formatDate';
import { calculateReadingTime } from '@/utils/readingTime';

interface Props {
  currentPost: CollectionEntry<'blog'>;
}

const { currentPost } = Astro.props;

// 모든 게시글 가져오기 (초안 제외)
const allPosts = await getCollection('blog', ({ data }) => !data.draft);

// 현재 게시글을 제외한 게시글들
const otherPosts = allPosts.filter((post) => post.id !== currentPost.id);

// 추천 점수 계산 함수
function calculateRecommendationScore(post: CollectionEntry<'blog'>): number {
  let score = 0;

  // 같은 카테고리면 높은 점수
  const sharedCategories = post.data.categories.filter((cat) =>
    currentPost.data.categories.includes(cat)
  );
  score += sharedCategories.length * 10;

  // 같은 태그면 점수 추가
  const sharedTags = post.data.tags.filter((tag) => currentPost.data.tags.includes(tag));
  score += sharedTags.length * 3;

  // 최신 게시글에 약간의 보너스 (시간이 가까울수록 높은 점수)
  const daysDiff = Math.abs(
    (new Date(post.data.date).getTime() - new Date(currentPost.data.date).getTime()) /
      (1000 * 60 * 60 * 24)
  );
  score += Math.max(0, 5 - daysDiff / 30); // 30일마다 1점 감소

  return score;
}

// 추천 게시글 계산
const recommendedPosts = otherPosts
  .map((post) => ({
    post,
    score: calculateRecommendationScore(post),
  }))
  .filter(({ score }) => score > 0) // 점수가 있는 것만
  .sort((a, b) => b.score - a.score) // 점수 높은 순
  .slice(0, 3) // 최대 3개
  .map(({ post }) => ({
    ...post,
    readingTime: calculateReadingTime(post.body || ''),
  }));

// 추천할 게시글이 없으면 컴포넌트를 렌더링하지 않음
if (recommendedPosts.length === 0) {
  return null;
}
---

<section class="mt-16 mb-12 pt-12 border-t border-border">
  <h2 class="text-2xl font-bold text-foreground mb-2 tracking-tight">추천 게시글</h2>
  <p class="text-sm text-muted-foreground/70 mb-8">이 글과 관련된 다른 게시글을 확인해보세요</p>

  <div class="grid gap-6 grid-cols-1 md:grid-cols-2 lg:grid-cols-3">
    {
      recommendedPosts.map((post) => (
        <a href={`/${post.id}`} class="block bg-card border border-border rounded-lg p-6 no-underline transition-all duration-200 hover:-translate-y-0.5 hover:shadow-lg hover:border-primary/50 h-full">
          <div class="flex flex-col h-full">
            <div class="flex flex-wrap gap-2 mb-3">
              {post.data.categories.map((cat) => (
                <span class="inline-block px-3 py-1 bg-primary text-primary-foreground text-xs font-medium rounded-full">{cat}</span>
              ))}
            </div>

            <h3 class="text-lg font-semibold text-foreground mb-3 tracking-tight line-clamp-2 break-keep">{post.data.title}</h3>

            <p class="text-sm text-muted-foreground mb-4 flex-grow line-clamp-2">{post.data.excerpt}</p>

            <div class="flex items-center gap-2 text-xs text-muted-foreground/70 mt-auto">
              <time datetime={new Date(post.data.date).toISOString()}>
                {formatDateShort(post.data.date)}
              </time>
              <span>·</span>
              <span>{post.readingTime}</span>
            </div>
          </div>
        </a>
      ))
    }
  </div>
</section>
