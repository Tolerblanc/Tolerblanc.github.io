---
/**
 * Giscus Comments Component
 *
 * GitHub Discussions ê¸°ë°˜ ëŒ“ê¸€ ì‹œìŠ¤í…œ
 *
 * ì„¤ì • ì •ë³´:
 * - repo: Tolerblanc/Tolerblanc.github.io
 * - repoId: R_kgDOJ01EaQ
 * - category: Announcements
 * - categoryId: DIC_kwDOJ01Eac4Cerab
 * - mapping: pathname (URL ê¸°ë°˜ ë§¤í•‘ìœ¼ë¡œ ê¸°ì¡´ ëŒ“ê¸€ ìœ ì§€)
 * - theme: ë™ì  (light â†” dark_dimmed)
 * - lang: ko (í•œêµ­ì–´)
 *
 * âš ï¸ View Transitions í˜¸í™˜ì„±:
 * astro:page-load ì´ë²¤íŠ¸ë¥¼ í™œìš©í•˜ì—¬ í˜ì´ì§€ ì „í™˜ ì‹œì—ë„ Giscusë¥¼ ì¬ì´ˆê¸°í™”í•©ë‹ˆë‹¤.
 *
 * ğŸ¨ í…Œë§ˆ ë™ê¸°í™”:
 * ë¸”ë¡œê·¸ì˜ ë¼ì´íŠ¸/ë‹¤í¬ ëª¨ë“œì— ë”°ë¼ Giscus í…Œë§ˆë„ ìë™ìœ¼ë¡œ ì „í™˜ë©ë‹ˆë‹¤.
 */
---

<div id="giscus-container"></div>

<script>
  // í˜„ì¬ í…Œë§ˆì— ë§ëŠ” Giscus í…Œë§ˆ ë°˜í™˜
  function getGiscusTheme() {
    const isDark = document.documentElement.classList.contains('dark');
    return isDark ? 'dark_dimmed' : 'light';
  }

  // Giscus iframeì— í…Œë§ˆ ë³€ê²½ ë©”ì‹œì§€ ì „ì†¡
  function updateGiscusTheme() {
    const iframe = document.querySelector<HTMLIFrameElement>('iframe.giscus-frame');
    if (!iframe) return;

    const theme = getGiscusTheme();
    iframe.contentWindow?.postMessage(
      {
        giscus: {
          setConfig: {
            theme: theme,
          },
        },
      },
      'https://giscus.app'
    );
  }

  let observer: MutationObserver | null = null;

  function loadGiscus() {
    const container = document.getElementById('giscus-container');
    if (!container) return;

    // ê¸°ì¡´ Giscus ì œê±° (ì¬ì´ˆê¸°í™”ë¥¼ ìœ„í•´)
    const existingGiscus = container.querySelector('.giscus');
    if (existingGiscus) {
      existingGiscus.remove();
    }

    // ê¸°ì¡´ ìŠ¤í¬ë¦½íŠ¸ ì œê±°
    const existingScript = container.querySelector('script');
    if (existingScript) {
      existingScript.remove();
    }

    // í˜„ì¬ í…Œë§ˆì— ë§ëŠ” Giscus í…Œë§ˆ ì„¤ì •
    const theme = getGiscusTheme();

    // ìƒˆë¡œìš´ Giscus ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
    const script = document.createElement('script');
    script.src = 'https://giscus.app/client.js';
    script.setAttribute('data-repo', 'Tolerblanc/Tolerblanc.github.io');
    script.setAttribute('data-repo-id', 'R_kgDOJ01EaQ');
    script.setAttribute('data-category', 'Announcements');
    script.setAttribute('data-category-id', 'DIC_kwDOJ01Eac4Cerab');
    script.setAttribute('data-mapping', 'pathname');
    script.setAttribute('data-strict', '0');
    script.setAttribute('data-reactions-enabled', '1');
    script.setAttribute('data-emit-metadata', '0');
    script.setAttribute('data-input-position', 'bottom');
    script.setAttribute('data-theme', theme);
    script.setAttribute('data-lang', 'ko');
    script.setAttribute('crossorigin', 'anonymous');
    script.async = true;

    container.appendChild(script);

    // ê¸°ì¡´ Observer ì •ë¦¬ í›„ ì¬ë“±ë¡
    if (observer) observer.disconnect();
    observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
          updateGiscusTheme();
        }
      });
    });
    observer.observe(document.documentElement, {
      attributes: true,
      attributeFilter: ['class'],
    });

    // iframe ë¡œë“œ ì™„ë£Œ í›„ í…Œë§ˆ ë™ê¸°í™”
    waitForGiscusIframe();
  }

  function waitForGiscusIframe() {
    const maxAttempts = 10;
    let attempts = 0;
    const interval = setInterval(() => {
      attempts++;
      const iframe = document.querySelector<HTMLIFrameElement>('iframe.giscus-frame');
      if (iframe || attempts >= maxAttempts) {
        clearInterval(interval);
        if (iframe) updateGiscusTheme();
      }
    }, 500);
  }

  // ì´ˆê¸° ë¡œë“œ
  loadGiscus();

  // View Transitions í˜ì´ì§€ ì „í™˜ ì‹œ ì¬ì´ˆê¸°í™”
  document.addEventListener('astro:page-load', loadGiscus);
</script>
