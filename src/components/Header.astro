---
import { Search } from './Search';
import { MobileMenu } from './MobileMenu';
import { getNavigationCategoryGroups, getRecentPosts } from '@/utils/navigation';

const currentPath = Astro.url.pathname;

const navItems = [
  { href: '/', label: 'Home' },
  { href: '/posts', label: 'Blog' },
  { href: '/series', label: 'Series' },
  { href: '/tags', label: 'Tags' },
  { href: '/about', label: 'About' },
];

// 모바일 메뉴를 위한 데이터
const categoryGroups = await getNavigationCategoryGroups();
const recentPosts = await getRecentPosts();

// 날짜 포맷팅
const formattedRecentPosts = recentPosts.map(post => ({
  slug: post.slug,
  title: post.title,
  date: post.date.toLocaleDateString('ko-KR', {
    month: 'short',
    day: 'numeric'
  })
}));
---

<header class="header">
  <nav class="nav-container">
    <div class="nav-left">
      <!-- Mobile Menu (모바일에서만 표시) -->
      <div class="mobile-menu-wrapper">
        <MobileMenu
          currentPath={currentPath}
          recentPosts={formattedRecentPosts}
          categoryGroups={categoryGroups}
          client:load
        />
      </div>

      <!-- Logo -->
      <a href="/" class="logo">
        <span class="logo-text">인생은 B와 D사이 Code다</span>
      </a>
    </div>

    <!-- Desktop Navigation (데스크톱에서만 표시) -->
    <div class="nav-center">
      <ul class="nav-links">
        {navItems.map(item => (
          <li>
            <a
              href={item.href}
              class={`nav-link ${currentPath === item.href || currentPath.startsWith(item.href + '/') ? 'active' : ''}`}
            >
              {item.label}
            </a>
          </li>
        ))}
      </ul>
    </div>

    <div class="nav-right">
      <Search client:load />
      <button id="theme-toggle" class="theme-toggle" aria-label="다크 모드 토글">
        <svg class="theme-icon theme-icon-light" width="20" height="20" viewBox="0 0 20 20" fill="none">
          <path d="M10 3V1M10 19V17M17 10H19M1 10H3M15.657 15.657L17.071 17.071M2.929 2.929L4.343 4.343M15.657 4.343L17.071 2.929M2.929 17.071L4.343 15.657" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <circle cx="10" cy="10" r="4" stroke="currentColor" stroke-width="2"/>
        </svg>
        <svg class="theme-icon theme-icon-dark" width="20" height="20" viewBox="0 0 20 20" fill="none">
          <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z" fill="currentColor"/>
        </svg>
      </button>
    </div>
  </nav>
</header>

<script is:inline>
  // 다크 모드 토글 스크립트
  function initThemeToggle() {
    const themeToggle = document.getElementById('theme-toggle');
    const html = document.documentElement;

    if (!themeToggle) {
      console.warn('Theme toggle button not found');
      return;
    }

    // 시스템 테마 감지 함수
    function getSystemTheme() {
      return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    }

    // 테마 적용 함수
    function applyTheme(theme) {
      let actualTheme = theme;
      if (theme === 'system') {
        actualTheme = getSystemTheme();
      }

      if (actualTheme === 'dark') {
        html.classList.add('dark');
      } else {
        html.classList.remove('dark');
      }
    }

    // 초기 테마 설정: localStorage > 시스템 설정 > 기본값(light)
    const savedTheme = localStorage.getItem('theme');
    const initialTheme = savedTheme || 'light';
    applyTheme(initialTheme);

    // 기존 리스너 제거를 위해 클론 생성
    const newToggle = themeToggle.cloneNode(true);
    themeToggle.parentNode.replaceChild(newToggle, themeToggle);

    // 테마 토글 버튼 이벤트 (새로운 버튼에 등록)
    newToggle.addEventListener('click', function() {
      // 테마 전환 애니메이션을 위한 클래스 추가
      html.classList.add('theme-transitioning');

      // 테마 전환
      html.classList.toggle('dark');
      const isDark = html.classList.contains('dark');
      const newTheme = isDark ? 'dark' : 'light';
      localStorage.setItem('theme', newTheme);

      // 200ms 후 전환 클래스 제거
      setTimeout(() => {
        html.classList.remove('theme-transitioning');
      }, 200);
    });

    // 시스템 테마 변경 감지
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function(e) {
      const savedTheme = localStorage.getItem('theme');
      if (!savedTheme || savedTheme === 'system') {
        applyTheme(e.matches ? 'dark' : 'light');
      }
    });
  }

  // 초기 로드
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initThemeToggle);
  } else {
    initThemeToggle();
  }

  // View Transitions 지원: 페이지 전환 시 재초기화
  document.addEventListener('astro:page-load', initThemeToggle);
</script>

<style>
  .header {
    position: fixed;
    top: 0;
    left: var(--layout-sidebar-width);
    right: 0;
    height: var(--layout-header-height);
    background-color: var(--color-bg-elevated);
    border-bottom: 1px solid var(--color-border-primary);
    z-index: var(--z-fixed);
  }

  .nav-container {
    display: flex;
    align-items: center;
    justify-content: space-between;
    height: 100%;
    padding: 0 var(--spacing-6);
    max-width: var(--layout-max-content-width);
    margin: 0 auto;
  }

  .nav-left {
    display: flex;
    align-items: center;
    gap: var(--spacing-3);
    flex-shrink: 0;
  }

  .mobile-menu-wrapper {
    display: none;
  }

  .logo {
    display: flex;
    align-items: center;
    text-decoration: none;
    color: var(--color-text-primary);
    font-weight: var(--font-weight-bold);
    font-size: var(--font-size-lg);
    transition: color var(--transition-fast);
  }

  .logo:hover {
    color: var(--color-accent-primary);
  }

  .logo-text {
    display: none;
  }

  @media (min-width: 1024px) {
    .logo-text {
      display: inline;
    }
  }

  .nav-center {
    flex: 1;
    display: flex;
    justify-content: center;
  }

  .nav-links {
    display: flex;
    gap: var(--spacing-1);
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .nav-link {
    display: flex;
    align-items: center;
    padding: var(--spacing-2) var(--spacing-4);
    text-decoration: none;
    color: var(--color-text-secondary);
    border-radius: var(--radius-md);
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    transition: all var(--transition-fast);
  }

  .nav-link:hover {
    background-color: var(--color-bg-secondary);
    color: var(--color-text-primary);
  }

  .nav-link.active {
    background-color: var(--color-accent-primary);
    color: #ffffff;
  }

  .nav-right {
    display: flex;
    align-items: center;
    gap: var(--spacing-2);
    flex-shrink: 0;
  }

  .theme-toggle {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    border: none;
    background-color: var(--color-bg-secondary);
    color: var(--color-text-primary);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .theme-toggle:hover {
    background-color: var(--color-bg-tertiary);
  }

  .theme-icon {
    width: 20px;
    height: 20px;
  }

  .theme-icon-light {
    display: none;
  }

  .theme-icon-dark {
    display: block;
  }

  :global(html:not(.dark)) .theme-icon-light {
    display: block;
  }

  :global(html:not(.dark)) .theme-icon-dark {
    display: none;
  }

  /* ===== 모바일 반응형 ===== */
  @media (max-width: 768px) {
    .header {
      left: 0;
      padding: 0;
    }

    .nav-container {
      padding: 0 var(--spacing-4);
    }

    .mobile-menu-wrapper {
      display: block;
    }

    .logo-text {
      display: inline;
      font-size: var(--font-size-base);
    }

    /* 데스크톱 네비게이션 숨기기 */
    .nav-center {
      display: none;
    }
  }

  /* 작은 모바일 화면 */
  @media (max-width: 480px) {
    .logo-text {
      font-size: var(--font-size-sm);
      max-width: 180px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .nav-container {
      padding: 0 var(--spacing-3);
    }
  }
</style>
