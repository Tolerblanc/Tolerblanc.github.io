---
import { Search } from './Search';
import { MobileMenu } from './MobileMenu';
import { getNavigationCategoryGroups, getRecentPosts } from '@/utils/navigation';

const currentPath = Astro.url.pathname;

const navItems = [
  { href: '/', label: 'Home' },
  { href: '/posts', label: 'Blog' },
  { href: '/series', label: 'Series' },
  { href: '/tags', label: 'Tags' },
  { href: '/about', label: 'About' },
];

// 모바일 메뉴를 위한 데이터
const categoryGroups = await getNavigationCategoryGroups();
const recentPosts = await getRecentPosts();

// 날짜 포맷팅
const formattedRecentPosts = recentPosts.map(post => ({
  slug: post.slug,
  title: post.title,
  date: post.date.toLocaleDateString('ko-KR', {
    year: '2-digit',
    month: 'short',
    day: 'numeric'
  })
}));
---

<header id="site-header" class="sticky top-0 z-40 w-full border-b border-transparent bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60 transition-[border-color,box-shadow] duration-200">
  <nav class="flex items-center justify-between h-14 md:h-16 px-4 md:px-8 max-w-screen-2xl mx-auto">
    <div class="flex items-center gap-4">
      <!-- Mobile Menu (모바일에서만 표시) -->
      <div class="md:hidden">
        <MobileMenu
          currentPath={currentPath}
          recentPosts={formattedRecentPosts}
          categoryGroups={categoryGroups}
          client:load
        />
      </div>

      <!-- Logo -->
      <a href="/" class="flex items-center gap-2 font-bold text-lg md:text-xl text-foreground hover:text-primary transition-colors">
        <span class="hidden md:inline-block">인생은 B와 D사이 Code다</span>
        <span class="md:hidden">B & D</span>
      </a>
    </div>

    <!-- Desktop Navigation (데스크톱에서만 표시) -->
    <div class="hidden md:flex items-center justify-center flex-1 px-8">
      <ul class="flex items-center gap-1">
        {navItems.map(item => (
          <li>
            <a
              href={item.href}
              class={`flex items-center px-4 py-2 text-sm font-medium rounded-md transition-colors ${
                currentPath === item.href || (item.href !== '/' && currentPath.startsWith(item.href))
                  ? 'bg-primary/10 text-primary'
                  : 'text-muted-foreground hover:bg-muted hover:text-foreground'
              }`}
            >
              {item.label}
            </a>
          </li>
        ))}
      </ul>
    </div>

    <div class="flex items-center gap-2">
      <Search client:load />
      <button id="theme-toggle" class="flex items-center justify-center w-9 h-9 rounded-md hover:bg-muted text-muted-foreground hover:text-foreground transition-colors" aria-label="다크 모드 토글">
        <svg class="w-5 h-5 hidden dark:block" viewBox="0 0 20 20" fill="none">
          <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z" fill="currentColor"/>
        </svg>
        <svg class="w-5 h-5 block dark:hidden" viewBox="0 0 20 20" fill="none">
          <path d="M10 3V1M10 19V17M17 10H19M1 10H3M15.657 15.657L17.071 17.071M2.929 2.929L4.343 4.343M15.657 4.343L17.071 2.929M2.929 17.071L4.343 15.657" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <circle cx="10" cy="10" r="4" stroke="currentColor" stroke-width="2"/>
        </svg>
      </button>
    </div>
  </nav>
</header>

<script is:inline>
  // 다크 모드 토글 스크립트
  function initThemeToggle() {
    const themeToggle = document.getElementById('theme-toggle');
    const html = document.documentElement;

    if (!themeToggle) {
      console.warn('Theme toggle button not found');
      return;
    }

    // 시스템 테마 감지 함수
    function getSystemTheme() {
      return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    }

    // 테마 적용 함수
    function applyTheme(theme) {
      let actualTheme = theme;
      if (theme === 'system') {
        actualTheme = getSystemTheme();
      }

      if (actualTheme === 'dark') {
        html.classList.add('dark');
      } else {
        html.classList.remove('dark');
      }
    }

    // 초기 테마 설정: localStorage > 시스템 설정 > 기본값(light)
    const savedTheme = localStorage.getItem('theme');
    const initialTheme = savedTheme || 'light';
    applyTheme(initialTheme);

    // 기존 리스너 제거를 위해 클론 생성
    const newToggle = themeToggle.cloneNode(true);
    themeToggle.parentNode.replaceChild(newToggle, themeToggle);

    // 테마 토글 버튼 이벤트 (새로운 버튼에 등록)
    newToggle.addEventListener('click', function() {
      // 테마 전환 애니메이션을 위한 클래스 추가
      html.classList.add('theme-transitioning');

      // 테마 전환
      html.classList.toggle('dark');
      const isDark = html.classList.contains('dark');
      const newTheme = isDark ? 'dark' : 'light';
      localStorage.setItem('theme', newTheme);

      // 200ms 후 전환 클래스 제거
      setTimeout(() => {
        html.classList.remove('theme-transitioning');
      }, 200);
    });

    // 시스템 테마 변경 감지
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function(e) {
      const savedTheme = localStorage.getItem('theme');
      if (!savedTheme || savedTheme === 'system') {
        applyTheme(e.matches ? 'dark' : 'light');
      }
    });
  }

  // 초기 로드
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initThemeToggle);
  } else {
    initThemeToggle();
  }

  // View Transitions 지원: 페이지 전환 시 재초기화
  document.addEventListener('astro:page-load', initThemeToggle);
</script>

<script is:inline>
  // Header scroll-aware border & shadow
  function initHeaderScroll() {
    const header = document.getElementById('site-header');
    if (!header) return;

    function updateHeader() {
      if (window.scrollY > 0) {
        header.style.borderColor = 'hsl(var(--border))';
        header.style.boxShadow = '0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1)';
      } else {
        header.style.borderColor = 'transparent';
        header.style.boxShadow = 'none';
      }
    }

    updateHeader();
    window.addEventListener('scroll', updateHeader, { passive: true });
  }

  initHeaderScroll();
  document.addEventListener('astro:page-load', initHeaderScroll);
</script>
