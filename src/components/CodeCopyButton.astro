---
// Code block copy button component
import { Check, Copy } from 'lucide-react';
---

<script>
  import { createRoot } from 'react-dom/client';
  import React from 'react';

  function initCodeCopyButtons() {
    const codeBlocks = document.querySelectorAll('pre');

    codeBlocks.forEach((pre) => {
      // Check if we already processed this block
      if (pre.parentElement?.classList.contains('group/code-block')) return;

      // Wrap the pre in a relative container (theme-aware)
      const wrapper = document.createElement('div');
      wrapper.className = 'relative group/code-block my-6 rounded-lg overflow-hidden';
      
      // Insert wrapper before pre
      pre.parentNode?.insertBefore(wrapper, pre);
      wrapper.appendChild(pre);
      
      // Styling the pre to match (reset styling issues)
      pre.classList.add('!my-0', '!rounded-none', 'p-4', 'overflow-x-auto');

      // Create button (theme-aware styling)
      const button = document.createElement('button');
      button.className = 'absolute top-3 right-3 p-2 rounded-md bg-black/10 dark:bg-white/10 text-foreground/70 hover:bg-black/20 dark:hover:bg-white/20 hover:text-foreground transition-all opacity-0 group-hover/code-block:opacity-100 focus:opacity-100 z-10';
      button.setAttribute('aria-label', 'Copy code');
      
      // Icon HTML
      const copyIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>`;
      const checkIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 text-green-400"><path d="M20 6 9 17l-5-5"/></svg>`;
      
      button.innerHTML = copyIcon;

      button.addEventListener('click', async () => {
        const code = pre.querySelector('code')?.innerText || pre.innerText;
        
        try {
          await navigator.clipboard.writeText(code);
          button.innerHTML = checkIcon;
          
          setTimeout(() => {
            button.innerHTML = copyIcon;
          }, 2000);
        } catch (err) {
          console.error('Failed to copy:', err);
        }
      });

      wrapper.appendChild(button);
    });
  }

  document.addEventListener('astro:page-load', initCodeCopyButtons);
</script>
