---
import { ViewTransitions } from 'astro:transitions';
import Sidebar from '@/components/Sidebar.astro';
import Header from '@/components/Header.astro';
import '@/styles/global.css';
import 'katex/dist/katex.min.css';

interface Props {
  title: string;
  description?: string;
  currentPath?: string;
}

const { title, description = 'Tolerblanc의 기술 블로그 - 인생은 B와 D사이 Code다', currentPath } = Astro.props;
const canonicalURL = new URL(Astro.url.pathname, Astro.site);
---

<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{title}</title>
    <meta name="description" content={description} />
    <link rel="canonical" href={canonicalURL} />

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#3182f6" />
    <link rel="manifest" href="/site.webmanifest" />
    <meta name="theme-color" content="#3182f6" />
    <meta name="msapplication-TileColor" content="#3182f6" />

    <!-- FOUC 방지: 테마 초기화 스크립트 -->
    <script is:inline>
      // 페이지 로드 전에 테마 적용 (FOUC 방지)
      (function() {
        function applyTheme() {
          const theme = localStorage.getItem('theme') || 'light';
          if (theme === 'dark') {
            document.documentElement.classList.add('dark');
          } else {
            document.documentElement.classList.remove('dark');
          }
        }
        
        // 초기 로드 시 즉시 적용
        applyTheme();
        
        // View Transitions: 페이지 전환 전에 테마 적용 (깜빡임 방지)
        if (typeof document !== 'undefined') {
          document.addEventListener('astro:before-swap', applyTheme);
        }
      })();
    </script>

    <!-- View Transitions for smooth page navigation -->
    <ViewTransitions />

    <!-- Google Analytics -->
    <script is:inline async src="https://www.googletagmanager.com/gtag/js?id=G-JWJT3DQR8G"></script>
    <script is:inline>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-JWJT3DQR8G');
    </script>

    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6434455556045128"
     crossorigin="anonymous"></script>

    <!-- Additional head content from pages -->
    <slot name="head" />
  </head>
  <body class="min-h-screen bg-background text-foreground antialiased selection:bg-accent selection:text-accent-foreground">

    <div class="flex min-h-screen flex-col md:flex-row">
      <Sidebar currentPath={currentPath || Astro.url.pathname} />
      <div class="flex-1 flex flex-col md:ml-64 transition-all duration-200 ease-in-out">
        <Header currentPath={currentPath || Astro.url.pathname} />
        <main class="flex-1 w-full max-w-screen-xl mx-auto px-4 sm:px-6 lg:px-8 py-8 md:py-12">
          <slot />
        </main>
      </div>
    </div>
  </body>
</html>

<style is:global>
  /* 테마 전환 시 주요 컨테이너만 부드럽게 전환
     주의: * 셀렉터는 Shiki 코드 블록의 수천 개 <span>에도 적용되어 심각한 성능 저하를 유발함 */
  html.theme-transitioning body,
  html.theme-transitioning header,
  html.theme-transitioning aside,
  html.theme-transitioning main {
    transition: background-color 0.15s ease, border-color 0.15s ease !important;
  }
</style>
