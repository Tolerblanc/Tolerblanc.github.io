---
import { ViewTransitions } from 'astro:transitions';
import Sidebar from '@/components/Sidebar.astro';
import Header from '@/components/Header.astro';
import '@/styles/global.css';
import 'katex/dist/katex.min.css';

interface Props {
  title: string;
  description?: string;
  currentPath?: string;
}

const { title, description = 'Tolerblanc의 기술 블로그 - 인생은 B와 D사이 Code다', currentPath } = Astro.props;
const canonicalURL = new URL(Astro.url.pathname, Astro.site);
---

<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{title}</title>
    <meta name="description" content={description} />
    <link rel="canonical" href={canonicalURL} />

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#3182f6" />
    <link rel="manifest" href="/site.webmanifest" />
    <meta name="theme-color" content="#3182f6" />
    <meta name="msapplication-TileColor" content="#3182f6" />

    <!-- FOUC 방지: 테마 초기화 스크립트 -->
    <script is:inline>
      // 페이지 로드 전에 테마 적용 (FOUC 방지)
      (function() {
        const theme = localStorage.getItem('theme') || 'light';
        if (theme === 'dark') {
          document.documentElement.classList.add('dark');
        }
      })();
    </script>

    <!-- View Transitions for smooth page navigation -->
    <ViewTransitions />

    <!-- Google Analytics -->
    <script is:inline async src="https://www.googletagmanager.com/gtag/js?id=G-JWJT3DQR8G"></script>
    <script is:inline>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-JWJT3DQR8G');
    </script>

    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6434455556045128"
     crossorigin="anonymous"></script>

    <!-- Additional head content from pages -->
    <slot name="head" />
  </head>
  <body>
    <!-- 사이드바 열기 버튼 (사이드바가 닫혔을 때만 표시) -->
    <button class="sidebar-open-btn" aria-label="사이드바 열기" title="사이드바 열기">
      <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
        <path d="M3 5H17M3 10H17M3 15H17" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
    </button>

    <div class="layout">
      <Sidebar currentPath={currentPath || Astro.url.pathname} />
      <div class="main-wrapper">
        <Header currentPath={currentPath || Astro.url.pathname} />
        <main class="content">
          <slot />
        </main>
      </div>
    </div>
  </body>
</html>

<style is:global>
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  html {
    font-family: var(--font-family-base);
    background: var(--color-bg-primary);
    color: var(--color-text-primary);
    transition: background-color var(--transition-base), color var(--transition-base);
  }

  body {
    line-height: var(--line-height-normal);
  }

  .layout {
    display: flex;
    min-height: 100vh;
  }

  .main-wrapper {
    flex: 1;
    margin-left: var(--layout-sidebar-width);
    display: flex;
    flex-direction: column;
    transition: margin-left var(--transition-base);
  }

  .content {
    flex: 1;
    margin-top: var(--layout-header-height);
    padding: var(--layout-container-padding);
    max-width: var(--layout-max-content-width);
    width: 100%;
    margin-left: auto;
    margin-right: auto;
  }

  /* 테마 전환 시 부드러운 애니메이션 (성능 최적화) */
  html.theme-transitioning,
  html.theme-transitioning * {
    transition: background-color 0.2s ease,
                color 0.2s ease,
                border-color 0.2s ease,
                box-shadow 0.2s ease !important;
  }

  /* 사이드바 열기 버튼 (왼쪽 상단 고정) */
  .sidebar-open-btn {
    position: fixed;
    top: var(--spacing-4);
    left: var(--spacing-4);
    z-index: calc(var(--z-modal) + 1);
    display: none;
    align-items: center;
    justify-content: center;
    width: 44px;
    height: 44px;
    border: none;
    background-color: var(--color-bg-elevated);
    color: var(--color-text-primary);
    border-radius: var(--radius-md);
    cursor: pointer;
    box-shadow: var(--shadow-card);
    transition: all var(--transition-fast);
    border: 1px solid var(--color-border-primary);
  }

  .sidebar-open-btn:hover {
    background-color: var(--color-bg-secondary);
    box-shadow: var(--shadow-card-hover);
  }

  .sidebar-open-btn:active {
    transform: scale(0.95);
  }

  /* 사이드바가 collapsed일 때만 표시 */
  .sidebar-open-btn.visible {
    display: flex;
  }

  /* Mobile Responsive */
  @media (max-width: 768px) {
    .main-wrapper {
      margin-left: 0;
    }
  }
</style>
