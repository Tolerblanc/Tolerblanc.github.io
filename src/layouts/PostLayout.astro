---
/**
 * Blog Post Layout
 *
 * 블로그 포스트를 위한 레이아웃 컴포넌트
 */

import type { CollectionEntry } from 'astro:content';
import type { MarkdownHeading } from 'astro';

import BaseLayout from './BaseLayout.astro';
import GiscusComments from '@/components/GiscusComments.astro';
import CodeCopyButton from '@/components/CodeCopyButton.astro';
import ScrollToTop from '@/components/ScrollToTop.astro';
import ReadingProgress from '@/components/ReadingProgress.astro';
import TableOfContents from '@/components/TableOfContents.astro';
import { SeriesNavigation } from '@/components/ui/series-navigation';
import { getCollection } from 'astro:content';
import PostRecommendations from '@/components/PostRecommendations.astro';

interface Props {
  post: CollectionEntry<'blog'>;
  headings: MarkdownHeading[];
}

const { post, headings } = Astro.props;
const { title, excerpt, date, updatedDate, categories, tags, description, toc, author, series } = post.data;

// 날짜 포맷팅
const formatDate = (date: Date) => {
  return new Intl.DateTimeFormat('ko-KR', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  }).format(new Date(date));
};

// TOC를 위한 필터링된 헤딩 (tocDepth에 따라)
const tocHeadings = headings.filter((h) => h.depth <= (post.data.tocDepth || 3));

// 시리즈 데이터 준비
let seriesData = null;
if (series) {
  const allPosts = await getCollection('blog', ({ data }) =>
    !data.draft && data.series?.name === series.name
  );

  const sortedPosts = allPosts
    .sort((a, b) => (a.data.series?.order || 0) - (b.data.series?.order || 0))
    .map(p => ({
      id: p.id,
      title: p.data.title,
      order: p.data.series?.order || 0
    }));

  const seriesSlug = series.name
    .toLowerCase()
    .replace(/\s+/g, '-')
    .replace(/[^\w\-가-힣]/g, '');

  seriesData = {
    seriesName: series.name,
    seriesSlug,
    posts: sortedPosts,
    currentPostId: post.id
  };
}
---

<BaseLayout title={`${title} | Tolerblanc's Blog`} description={description || excerpt}>
  <Fragment slot="head">
    <meta name="author" content={author} />
    <meta property="og:type" content="article" />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description || excerpt} />
    {post.data.ogImage && (
      <>
        <meta property="og:image" content={post.data.ogImage} />
        <meta name="twitter:image" content={post.data.ogImage} />
      </>
    )}
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description || excerpt} />
    <meta property="article:published_time" content={new Date(date).toISOString()} />
    {updatedDate && <meta property="article:modified_time" content={new Date(updatedDate).toISOString()} />}
    <meta property="article:author" content={author} />
    {categories.map((cat) => <meta property="article:section" content={cat} />)}
    {tags.map((tag) => <meta property="article:tag" content={tag} />)}
  </Fragment>

  <div class="relative w-full flex justify-center gap-12 xl:gap-16 px-4 md:px-8">
    <article class="w-full max-w-3xl flex-shrink-0">
      <!-- Header -->
      <header class="mb-12 border-b pb-8">
        {series && (
          <div class="mb-4 text-sm font-medium text-muted-foreground">
            <span class="font-semibold text-primary">{series.name}</span> 시리즈 · 제{series.order}편
          </div>
        )}

        <h1 class="mb-4 text-3xl md:text-4xl font-bold tracking-tight text-foreground break-keep">
          {title}
        </h1>

        <div class="mb-6 flex flex-wrap gap-4 text-sm text-muted-foreground">
          <time datetime={new Date(date).toISOString()}>
            {formatDate(date)}
          </time>
          {updatedDate && (
            <span>
              (수정: <time datetime={new Date(updatedDate).toISOString()}>{formatDate(updatedDate)}</time>)
            </span>
          )}
          <span>by {author}</span>
        </div>

        {excerpt && <p class="mb-6 text-lg text-muted-foreground leading-relaxed">{excerpt}</p>}

        <!-- Categories and Tags -->
        <div class="flex flex-col gap-3">
          <div class="flex flex-wrap gap-2">
            {categories.map((cat) => (
              <span class="px-3 py-1 rounded-full text-sm font-medium bg-primary text-primary-foreground hover:bg-primary/90 transition-colors">
                {cat}
              </span>
            ))}
          </div>
          {tags.length > 0 && (
            <div class="flex flex-wrap gap-2">
              {tags.map((tag) => (
                <span class="px-2 py-0.5 rounded text-xs font-medium bg-secondary text-secondary-foreground border border-border hover:bg-secondary/80 transition-colors">
                  #{tag}
                </span>
              ))}
            </div>
          )}
        </div>
      </header>

      <!-- Series Navigation (Collapsible or Card style) -->
      {seriesData && (
        <div class="mb-10">
           <SeriesNavigation
            seriesName={seriesData.seriesName}
            seriesSlug={seriesData.seriesSlug}
            posts={seriesData.posts}
            currentPostId={seriesData.currentPostId}
            client:load
          />
        </div>
      )}

      <!-- Main Content -->
      <main class="prose prose-lg dark:prose-invert max-w-none break-words">
        <slot />
      </main>

      <!-- Comments Section -->
      <div class="mt-16 pt-8 border-t">
          <GiscusComments />
      </div>

      <!-- Recommended Posts -->
      <PostRecommendations currentPost={post} />

    </article>

    <!-- TOC Sidebar (Desktop only) -->
    {toc && tocHeadings.length > 0 && (
      <aside class="hidden xl:block w-64 flex-shrink-0 sticky top-24 h-fit max-h-[calc(100vh-8rem)] overflow-y-auto">
        <TableOfContents headings={tocHeadings} />
      </aside>
    )}

    <!-- UI Enhancement Components -->
    <ReadingProgress />
    <CodeCopyButton />
    <ScrollToTop />
  </div>
</BaseLayout>
